#!/usr/bin/env bash

# shellcheck disable=SC2155

set -Eeuo pipefail
trap 'print_error ${BASH_SOURCE[0]} ${LINENO} ${?}' ERR

# Arguments
readonly SCRIPT_DIR="$(cd "$(dirname "${0}")" && pwd)"

# Settings
readonly BASH_COMPLETION_DIR="${HOME}/dev/data/bash/completion"

echo_error()
{
    echo -e "\e[0;31m${*}\e[0m"
}

print_error()
{
    local -r SOURCE_PATH="${1}"
    local -r LINE_NUMBER="${2}"
    local -r EXIT_STATUS="${3}"
    local -r CONTEXT_LINES="3"
    local -r SOURCE_CODE="$(pr -tn "${SOURCE_PATH}")"

    local RELATIVE_PATH="${SOURCE_PATH#"${SCRIPT_DIR}"}"
    local -r RELATIVE_PATH="${RELATIVE_PATH#/}"

    echo
    echo_error "\e[1mError: command exited with status ${EXIT_STATUS} at ${RELATIVE_PATH}:${LINE_NUMBER}"

    tail -n +$((LINE_NUMBER - CONTEXT_LINES)) <<< "${SOURCE_CODE}" | head -n ${CONTEXT_LINES}
    echo_error "\e[1m$(tail -n +$((LINE_NUMBER)) <<< "${SOURCE_CODE}" | head -n 1)"
    tail -n +$((LINE_NUMBER + 1)) <<< "${SOURCE_CODE}" | head -n ${CONTEXT_LINES}
    echo

    exit 1
}

check_bin()
{
    if ! command -v "${1}" &> /dev/null; then
        echo_error "Error: \"${1}\" not found."
        exit 1
    fi
}

echo_generate()
{
    echo "Generate bash completion: ${*}"
}

main()
{
    if [ ! -d "${BASH_COMPLETION_DIR}" ]; then
        mkdir -p "${BASH_COMPLETION_DIR}"
    fi

    rm -rf "${BASH_COMPLETION_DIR:?}"/*

    echo_generate helm
    check_bin helm
    helm completion bash > "${BASH_COMPLETION_DIR}/helm"

    echo_generate jfrog
    check_bin jfrog
    export JFROG_CLI_HOME_DIR="${BASH_COMPLETION_DIR}"
    jfrog completion bash > /dev/null

    echo_generate kubectl
    check_bin kubectl
    kubectl completion bash > "${BASH_COMPLETION_DIR}/kubectl"

    echo_generate kubectl krew
    check_bin kubectl-krew
    kubectl krew completion bash > "${BASH_COMPLETION_DIR}/kubectl-krew"

    echo_generate npm
    check_bin npm
    npm completion > "${BASH_COMPLETION_DIR}/npm"

    echo_generate pip
    check_bin pip
    pip completion --bash > "${BASH_COMPLETION_DIR}/pip"

    echo_generate pip3
    check_bin pip3
    pip3 completion --bash > "${BASH_COMPLETION_DIR}/pip3"

    echo_generate yq
    check_bin yq
    yq shell-completion bash > "${BASH_COMPLETION_DIR}/yq"
}

main
